# .github/workflows/pr-checks.yml
# GitHub Actions workflow to enforce commit message and branch naming conventions on pull requests.
# This workflow runs on pull requests targeting the main, master, or develop branches.
name: PR Checks

on:
  pull_request:
    branches: [main, master, develop]

jobs:
  commitlint:
    name: Commitlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Validate commits
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  branch-naming:
    name: Branch + PR Title Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Validate PR title
        run: |
          title="${{ github.event.pull_request.title }}"
          types="feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert|hotfix|claude"
          pattern="^($types): [a-z0-9][a-z0-9 .,'/-]*$"

          if ! echo "$title" | grep -qE "$pattern"; then
            echo "❌ PR title '$title' doesn't match the required pattern."
            echo ""
            echo "Valid format:"
            echo "  type: lower-case description  →  feat: add export tools"
            echo ""
            echo "Types: $types"
            exit 1
          fi
          echo "✓ PR title '$title' is valid"

      - name: Auto-label by PR type
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const match = title.match(/^([a-z]+):/);
            if (!match) {
              core.setFailed("PR title missing type prefix.");
              return;
            }

            const type = match[1];
            const allowed = [
              "feat",
              "fix",
              "docs",
              "style",
              "refactor",
              "perf",
              "test",
              "chore",
              "ci",
              "build",
              "revert",
              "hotfix",
              "claude",
            ];

            if (!allowed.includes(type)) {
              core.setFailed(`Unsupported PR type: ${type}`);
              return;
            }

            const colors = {
              feat: "0E8A16",
              fix: "D93F0B",
              docs: "0075CA",
              style: "F9D0C4",
              refactor: "5319E7",
              perf: "1D76DB",
              test: "FBCA04",
              chore: "CCCCCC",
              ci: "0E8A16",
              build: "C2E0C6",
              revert: "E99695",
              hotfix: "D93F0B",
              claude: "CC785C",
            };

            const labelName = type;
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
              });
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
                color: colors[type] ?? "CCCCCC",
              });
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [labelName],
            });

      - name: Validate branch name
        run: |
          branch="${{ github.head_ref }}"
          types="feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert|hotfix|claude"
          pattern="^($types)/[a-z0-9-]+$"

          if ! echo "$branch" | grep -qE "$pattern"; then
            echo "❌ Branch name '$branch' doesn't match the required pattern."
            echo ""
            echo "Valid format:"
            echo "  type/description  →  feat/add-button, fix/auth-bug"
            echo ""
            echo "Types: $types"
            exit 1
          fi
          echo "✓ Branch name '$branch' is valid"
